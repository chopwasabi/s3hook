<html>
<head>
  <title>S3 Hook Demo</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap-theme.min.css">

  <style type="text/css">
    body {
      padding-top: 20px
    }
    .container {
      padding-bottom: 60px;
    }
    .inputs input, .inputs select, .inputs textarea , .inputs .button-box{
      margin-top: 5px
    }
    textarea {
      font-family: Courier;
    }
    select {
      width: 100%;
      font-size: 14px;
      border: thin solid grey;
      height: 32px;
    }
    .send.btn {
      width: 200px
    }
    .file.btn {
      margin: 10px;
    }
    .dropzone {
      border-radius: 5px;
      margin: 5px;
      padding: 10px;
    }
    .button-box {
      font-weight: normal !important;
      font-style: italic;
      padding-left: 20px;
    }
  </style>
</head>
<body ng-app="s3-demo">

  <a href="https://github.com/jpillora/s3hook">
    <img style="position: fixed; top: 0; right: 0; border: 0; z-index: 99999;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>

  <div class="container">
    <nav class="navbar navbar-default" role="navigation">
      <div class="navbar-header">
        <div class="navbar-brand">A Serverless Client for AWS Simple Storage Service</div>
      </div>
    </nav>

    <div class="inputs">
      
      <input type="text" class="form-control"
             placeholder="AWS Access key"
             ng-model="access" ng-change="setKeys()">

      <input type="text" class="form-control"
             placeholder="AWS Secret key"
             ng-model="secret" ng-change="setKeys()">

      <div class="button-box" ng-show="hasLocalStorage">
        <input id="remember" type="checkbox" ng-model="remember" ng-change="setRemember()">
        <label for="remember">Keep keys in Local Storage</label>
      </div>

      <select ng-options="s for s in methods" ng-model="method">
      </select>

      <select ng-options="s for s in endpoints"
              ng-model="endpoint" ng-change="setURL()">
      </select>

      <input type="text" class="form-control"
             placeholder="Request Path"
             ng-init="path='my-awesome-bucket/my-secret-file.txt'"
             ng-keydown="$event.keyCode == 13 && run()"
             ng-model="path" ng-change="setURL()">

      <div ng-show="method != 'GET' && method != 'DELETE'">

        <div>
          <button type="button" class="file btn btn-default btn-xs"
            ng-click="fileBody = !fileBody"
            ng-class="{active:fileBody}"
            >Upload File</button>
        </div>  

        <p class="dropzone"
            ng-show="fileBody"
            ng-class="hover && 'bg-primary' || 'bg-info'"
            ng-bind="filePath || 'Drop a file here...'"></p>

        <textarea type="text" class="form-control"
               ng-show="!fileBody"
               placeholder="Request Body"
               ng-model="body"></textarea>

      </div>



      <div class="row" ng-repeat="header in headers">
        <div class="col-md-6">
          <input type="text" class="form-control" placeholder="Header name"
                 ng-model="header.name", ng-change="updateHeaders()"
                 ng-keydown="$event.keyCode == 13 && run()"></input>
        </div>
        <div class="col-md-6">
          <input type="text" class="form-control" placeholder="Header value"
                 ng-model="header.value", ng-change="updateHeaders()"
                 ng-keydown="$event.keyCode == 13 && run()"></input>
        </div>
      </div>

      <div style="text-align: center;">
        <button type="button"
               class="btn send btn-default navbar-btn"
               ng-disabled="running || !access || !secret"
               ng-click="run()">Send</button>
        <a href="http://docs.aws.amazon.com/AmazonS3/latest/API/APIRest.html"
           target="_blank">
          S3 REST API Docs
        </a>
      </div>
    </div>

    <div class="output">
      Request URL:<br>
      <pre ng-bind="url || '...'"></pre>
      <!-- 
      Request Headers:<br>
      <pre ng-bind="requestHeaders || '...'"></pre>
      -->
      Response Code:<br>
      <pre ng-bind="responseCode || '...'"></pre>
      Response Headers:<br>
      <pre ng-bind="responseHeaders || '...'"></pre>
      Response Text:<br>
      <pre ng-bind="responseText"></pre>

      <span class="muted">Note: <code>*/xml</code> is silently converted to <code>application/json</code> unless <code>s3hook.xml2json</code> is set to <code>false</code>.</span>

    </div>
  </div>

  <script type="text/javascript" src="dist/0.3/s3hook.js"></script>

  <script type="text/javascript"
          src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.9/angular.js"></script>

  <script type="text/javascript">
    angular.module('s3-demo', []).run(function($rootScope, $timeout, $http) {

      scope = window.root = $rootScope;
      scope.hasLocalStorage = !!window.localStorage;
      scope.running = false;
      scope.fileBody = true;
      scope.endpoints = s3hook.endpoints()
      scope.headers = [{}] //{name: 'x-amz-acl', value: 'public-read'}, 
      scope.methods = [
        "GET",
        "PUT",
        "POST",
        "DELETE"
      ]

      //defaults
      scope.method = scope.methods[0]
      scope.endpoint = scope.endpoints[0]

      scope.updateHeaders = function() {
        var spare = -1;
        var full = true;
        for(var i in scope.headers){
          var h = scope.headers[i];
          if(!h.name || !h.value) {
            if(!full)
              spare = +i;
            full = false;
          }
        }
        if(full)
          scope.headers.push({});
        else if(!full && spare >= 1)
          scope.headers.splice(spare, 1);
      }

      scope.setRemember = function() {
        var r = scope.remember;
        localStorage.setItem('access', r ? scope.access : '');
        localStorage.setItem('secret', r ? scope.secret : '');
      }

      scope.setKeys = function() {
        s3hook(scope.access, scope.secret);
        if(scope.remember){
          localStorage.setItem('access', scope.access);
          localStorage.setItem('secret', scope.secret);
        }
      };

      scope.setURL = function() {
        scope.url = scope.endpoint + "/" + scope.path;
      };

      scope.run = function() {

        scope.running = true;


        var xhr = new XMLHttpRequest();

        xhr.open(scope.method, scope.url);

        for(var i in scope.headers) {
          var h = scope.headers[i], n = h.name, v = h.value;
          if(n && v)
            xhr.setRequestHeader(n, v);
        }


        xhr.onreadystatechange = function() {
          if(xhr.readyState !== 4) return;

          scope.responseCode = xhr.status;
          scope.responseHeaders = xhr.getAllResponseHeaders();
          // scope.responseText = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
          scope.responseText = xhr.responseText;
          scope.running = false;
          scope.$apply();
        } 

        xhr.send(scope.fileBody ? scope.file : scope.body);
      };

      $timeout(function() {
        if(scope.hasLocalStorage) {
          scope.access = localStorage.getItem('access');
          scope.secret = localStorage.getItem('secret');
          scope.remember = !!scope.access && !!scope.secret;
          scope.setKeys();
        }
        scope.setURL();
      });
    }).directive('dropzone', function($rootScope) {
      var scope = $rootScope;
      return {
        restrict: 'C',
        link: function(sc, elem, attr) {
          var dropper = elem[0]
          dropper.ondragover = function () {
            scope.hover = true;
            scope.$apply();
            return false;
          };
          dropper.ondragend = function () { 
            scope.hover = false;
            scope.$apply();
            return false;
          };
          dropper.ondrop = function (e) {
            e.preventDefault();
            var file = e.dataTransfer.files[0];
            scope.file = file;
            scope.filePath = file.name;
            scope.$apply();
            return false;
          };
        }
      }
    });
  </script>
</body>
</html>